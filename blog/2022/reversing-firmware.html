<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta charset="utf-8">
    <title>Reversing IOT Firmware - c0mpr0mys3</title>
    <link rel="stylesheet" href="/assets/css/main.css">
    <link rel="stylesheet" href="/assets/css/all.min.css">
    <script src="/assets/js/typewriter.js"></script>
    <script src="/assets/js/jquery.min.js"></script>
  </head>
  <script>
    function openNav() {
    document.getElementById("mySidenav").style.width = "250px";
  }

  function closeNav() {
    document.getElementById("mySidenav").style.width = "0";
  }
  </script>
  <body style="background-color: #0f0e12;">
    <link rel="shortcut icon" type="image/png" href="/favicon.ico">
    <div class = flex><nav class="bg-background navbar hidden 
            relative md:flex w-full flex-row items-center 
            justify-start py-4 text-gray-500 shadow-lg">
    
    <div class="ml-2 flex flex-grow flex-row">
      <a href="/" class="ml-2 rounded font-mono text-xl
      text-white transition-all px-2 pt-1 pb-0
      hover:bg-gray-700">~/compromyse</a>
  
      <a href="/blog" class="ml-3 rounded font-mono px-2
      transition-all pt-1 pb-0
      hover:bg-gray-700">/dev/blog</a>
  
      <a href="/about" class="ml-3 rounded font-mono px-2
      transition-all hover:bg-gray-700 pt-1 pb-0">/usr/about</a>
  
      <a href="/ctf" class="ml-3 rounded font-mono px-2
      transition-all hover:bg-gray-700 pt-1 pb-0">/bin/ctf</a>
  
      <i class="fa fa-search ml-auto mr-5 rounded hover:bg-gray-700
                px-2 pt-2" style="cursor: pointer;" onclick="openSearch();"></i>
    </div>
</nav>

<div id="myOverlay" class="overlay">
  <div class="relative flex flex-col top-1/4 w-4/5
              mt-8 m-auto">
      <input type="text" id="search-input" placeholder="Search.." name="search"
        class="search-bar">
    <ul id="results-container" class="text-white text-xl overflow-auto
                                      pb-4 h-96"></ul>
  </div>
</div>

<script>
// Open the full screen search box
function openSearch() {
  document.getElementById("myOverlay").style.display = "block";
}

// Close the full screen search box
function closeSearch() {
  document.getElementById("myOverlay").style.display = "none";
}

function openNav() {
  document.getElementById("mySidenav").style.width = "250px";
}

function closeNav() {
  document.getElementById("mySidenav").style.width = "0";
}
</script>

<script src="/assets/js/search-script.js" type="text/javascript"></script>

<script>
  SimpleJekyllSearch({
    searchInput: document.getElementById('search-input'),
    resultsContainer: document.getElementById('results-container'),
    json: '/search.json'
  })

  document.addEventListener('keyup', function(event) {
    if ( event.keyCode == 27 ) {
      closeSearch()
    }
  })
</script>

<style>
body {
  font-family: "Lato", sans-serif;
}

.sidenav {
  height: 100%;
  width: 0;
  position: fixed;
  z-index: 1;
  top: 0;
  right: 0;
  background-color: #0f0e12;
  overflow-x: hidden;
  transition: 0.5s;
  padding-top: 60px;
}

.sidenav a {
  padding: 8px 8px 8px 32px;
  text-decoration: none;
  font-size: 25px;
  color: #818181;
  display: block;
  transition: 0.3s;
}

.sidenav .closebtn {
  position: absolute;
  top: 0;
  right: 25px;
  font-size: 36px;
  margin-left: 50px;
}

@media screen and (max-height: 450px) {
  .sidenav {padding-top: 15px;}
  .sidenav a {font-size: 18px;}
}
</style>

<div id="mySidenav" class="sidenav">
  <a href="javascript:void(0)" class="closebtn" onclick="closeNav()">&times;</a>
  <a href="/blog">Blog</a>
  <a href="/about">About</a>
  <a href="/ctf">CTF</a>
</div>

<nav class="bg-background navbar md:hidden flex 
            relative w-full flex-row items-center 
            justify-start py-4 text-gray-500 shadow-lg">
    
    <div class="ml-2 flex flex-grow flex-row">
      <a href="/" class="ml-2 rounded font-mono text-xl
      text-white transition-all px-2 pt-1 pb-0
      hover:bg-gray-700">~/compromyse</a>
  
    <button class="fa fa-bars mr-5 rounded ml-auto
                        px-2 pt-2" style="cursor: pointer;" onclick="openNav()"></button>
    </div>
</nav></div>
    <div class="mb-12">
    <div class="pb-10">
  <div class="text-3xl text-white font-mono text-center pt-7">
    Reversing IOT Firmware
  </div>
  <div class="text-lg text-white font-mono text-center pt-3">
    Ever wondered how you could reverse IOT Firmware To Get To A Linux Filesystem?
  </div>
  <div class="font-mono text-center pt-2">
  
    <a class="text-gray-400">reversing</a>
  
  </div>
  <div class="text-xl text-white font-mono text-center">
  <a class="text-datesearch text-sm">8 May 2022 	&#9679; 17 min read</a>
  </div>
</div>

<div class="prose md:prose-lg lg:prose-xl prose-invert mx-auto items-center prose-pink pb-12">
  <h3 id="introduction">Introduction</h3>

<p>The goal of this article is to get a firmware binary file, reverse it and try to extract it’s <code class="language-plaintext highlighter-rouge">Linux Filesystem</code>.</p>

<p>Now, what is a <code class="language-plaintext highlighter-rouge">filesystem</code>? Think of a <code class="language-plaintext highlighter-rouge">filesystem</code> as a structured folder. Linux’s filesystem consists of many different folders, most linux distributions follow the structure below but not all do. They are free to choose whatever structure they like, this is pretty standard.</p>

<p><img src="/assets/img/posts/linux_filesystem_tree.png" alt="LinuxFileSystem" />
<em>source: oreilly.com</em></p>

<h3 id="why-reverse-firmware">Why Reverse Firmware?</h3>

<p>There are many reasons to reverse IOT/Device firmware. Here are some of them:</p>
<ul>
  <li>Security Auditing the Firmware.</li>
  <li>Creating software compatible with the device if the manufacturer has not released an SDK.</li>
  <li>To learn about it’s innards.</li>
</ul>

<h3 id="tooling">Tooling</h3>

<ul>
  <li>Linux</li>
</ul>

<p>If you’re on <code class="language-plaintext highlighter-rouge">Windows</code>, install <code class="language-plaintext highlighter-rouge">Linux</code> in a Virtual Machine (Oracle Virtualbox, VMware or Hyper-V). Preferably a <code class="language-plaintext highlighter-rouge">Debian</code> based distribution like <code class="language-plaintext highlighter-rouge">Ubuntu</code> or <code class="language-plaintext highlighter-rouge">Kali</code>, since it’s the most supported.</p>

<ul>
  <li>dd</li>
</ul>

<p><code class="language-plaintext highlighter-rouge">dd</code> is preinstalled on most if not all <code class="language-plaintext highlighter-rouge">Linux</code> distributions.</p>

<ul>
  <li>binwalk</li>
</ul>

<p>You can install <code class="language-plaintext highlighter-rouge">binwalk</code> with</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>apt-get <span class="nb">install </span>binwalk
</code></pre></div></div>

<ul>
  <li>unsquashfs
You can install <code class="language-plaintext highlighter-rouge">unsquashfs</code> with
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>apt-get <span class="nb">install </span>squashfs-tools
</code></pre></div>    </div>
  </li>
</ul>

<p>If <code class="language-plaintext highlighter-rouge">binwalk</code> is not present in your distribution’s software repositories, you will have to manually install it.</p>

<h3 id="actually-reversing-it">Actually Reversing It</h3>

<p>For this example we will be using <a href="https://web.archive.org/web/20220509051908/https://www.downloads.netgear.com/files/GDC/WN3000RPV2/WN3000RPv2-V1.0.0.92.zip">this</a> firmware image.</p>

<p>We first need to extract the <code class="language-plaintext highlighter-rouge">.zip</code> file with</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>unzip WN3000RPv2-V1.0.0.92.zip
</code></pre></div></div>
<p>to get the actual firmware image, the <code class="language-plaintext highlighter-rouge">.img</code> file.</p>

<p>Running</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>file WN3000RPv2-V1.0.0.92.zip
</code></pre></div></div>
<p>will give us<code class="language-plaintext highlighter-rouge">WN3000RPv2-V1.0.0.92.img: data</code>. Not useful at all.</p>

<p>Now, this is a proprietary firmware image, so we don’t know it’s structure. We can use <code class="language-plaintext highlighter-rouge">binwalk</code> to see all embedded files. Every file has <code class="language-plaintext highlighter-rouge">magic bytes</code> that tells us what format it is in. <code class="language-plaintext highlighter-rouge">binwalk</code> searches for these magic bytes in the file, for example, there could be a <code class="language-plaintext highlighter-rouge">.png</code> file thats magic bytes are correct, and it renders out correctly. But it can have a <code class="language-plaintext highlighter-rouge">.jpg</code> or any other file embedded at the end of the file. This would approximately be the file structure for it.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PNG file magic bytes
PNG file data
JPG file magic bytes
JPG file data
</code></pre></div></div>

<p>This is essentially hiding/embedding the <code class="language-plaintext highlighter-rouge">.jpg</code> file in the png file. This is pretty common in <code class="language-plaintext highlighter-rouge">steganography</code></p>

<p>Moving back to the firmware file, we can use <code class="language-plaintext highlighter-rouge">binwalk</code> to find the file structure. Running <code class="language-plaintext highlighter-rouge">binwalk WN3000RPv2-V1.0.0.92.img</code> will give us this output:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>DECIMAL       HEXADECIMAL     DESCRIPTION
--------------------------------------------------------------------------------
128           0x80            uImage header, header size: 64 bytes, header CRC: 0xB66ED1F1, created: 2022-02-07 09:04:01, image size: 982848 bytes, Data Address: 0x80000000, Entry Point: 0x8000C570, data CRC: 0x9160FBE3, OS: Linux, CPU: MIPS, image type: OS Kernel Image, compression type: lzma, image name: "MIPS OpenWrt Linux-2.6.36"
192           0xC0            LZMA compressed data, properties: 0x6D, dictionary size: 8388608 bytes, uncompressed size: 3062516 bytes
983104        0xF0040         uImage header, header size: 64 bytes, header CRC: 0x863A1B34, created: 2022-02-07 09:04:01, image size: 2490372 bytes, Data Address: 0x80000000, Entry Point: 0x8000C570, data CRC: 0x65B10B31, OS: Linux, CPU: MIPS, image type: OS Kernel Image, compression type: lzma, image name: "MIPS OpenWrt Linux-2.6.36"
983168        0xF0080         Squashfs filesystem, little endian, version 4.0, compression:lzma, size: 2412158 bytes, 715 inodes, blocksize: 131072 bytes, created: 2022-02-07 09:03:58
</code></pre></div></div>

<p>We are looking for the <code class="language-plaintext highlighter-rouge">Squashfs filesystem</code>, since it contains the filesystem of this firmware image.</p>

<h3 id="extracting-the-filesystem">Extracting The Filesystem</h3>

<p>There are two ways of extracting the filesystem, using <code class="language-plaintext highlighter-rouge">binwalk</code> itself and using <code class="language-plaintext highlighter-rouge">dd</code>.</p>

<ul>
  <li>binwalk</li>
</ul>

<p>Running</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>binwalk <span class="nt">-e</span> WN3000RPv2-V1.0.0.92.img
</code></pre></div></div>
<p>Will extract all data/sections found. The <code class="language-plaintext highlighter-rouge">Squashfs</code> filesystem is one of them. After running the command, there will be a <code class="language-plaintext highlighter-rouge">_WN3000RPv2-V1.0.0.92.img.extracted</code> directory. <code class="language-plaintext highlighter-rouge">binwalk</code> automatically extracts the <code class="language-plaintext highlighter-rouge">Squashfs</code> filesystem in the <code class="language-plaintext highlighter-rouge">squashfs-root</code>. The <code class="language-plaintext highlighter-rouge">squashfs-root</code> directory is the root directory of the filesystem in the firmware.</p>

<ul>
  <li>dd</li>
</ul>

<p>From the output of the <code class="language-plaintext highlighter-rouge">binwalk</code> command, we can see the <code class="language-plaintext highlighter-rouge">Squashfs</code> section:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>DECIMAL       HEXADECIMAL     DESCRIPTION                                                  
--------------------------------------------------------------------------------       
983168        0xF0080         Squashfs filesystem, little endian, version 4.0, compression:    lzma, size: 2412158 bytes, 715 inodes, blocksize: 131072 bytes, created: 2022-02-07 09:03:5    8
</code></pre></div></div>

<p>We can extract the <code class="language-plaintext highlighter-rouge">Squashfs filesystem</code> with</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">dd </span><span class="k">if</span><span class="o">=</span>WN3000RPv2-V1.0.0.92.img <span class="nv">skip</span><span class="o">=</span>983168 <span class="nv">of</span><span class="o">=</span>filesystem.squashfs <span class="nv">bs</span><span class="o">=</span>1
</code></pre></div></div>

<p>We will have to replace <code class="language-plaintext highlighter-rouge">skip</code> with <code class="language-plaintext highlighter-rouge">DECIMAL</code> from the binwalk command. In this case, <code class="language-plaintext highlighter-rouge">983168</code> since the decimal value in the binwalk command is <code class="language-plaintext highlighter-rouge">983168</code></p>

<p>Here are the parts of the command</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>------------------------------
if   | input file
------------------------------
of   | output file
------------------------------
skip | number of bytes to skip
------------------------------
bs   | block size
------------------------------
</code></pre></div></div>

<p>This will create <code class="language-plaintext highlighter-rouge">filesystem.squashfs</code> in the current directory. When we run <code class="language-plaintext highlighter-rouge">file filesystem.squashfs</code> we can see that the output tells us it’s a squashfs filesystem.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>filesystem.squashfs: Squashfs filesystem, little endian, version 4.0, lzma compressed, 2412158 bytes, 715 inodes, blocksize: 131072 bytes, created: Mon Feb  7 09:03:58 2022
</code></pre></div></div>

<p>We can now use <code class="language-plaintext highlighter-rouge">unsquashfs</code> to extract the filesystem.</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>unsquashfs filesystem.squashfs
</code></pre></div></div>

<p>This will create a <code class="language-plaintext highlighter-rouge">squashfs-root</code> directory. The <code class="language-plaintext highlighter-rouge">squashfs-root</code> directory is the root directory of the filesystem in the firmware.</p>

<h4 id="thank-you-for-reading">Thank you for reading!</h4>

</div>
    </div><footer class="absolute bottom-0 w-full h-auto p-4 shadow 
    flex items-center justify-center md:p-6 bg-background
    overflow-hidden left-0 pt-3">
    <span class="text-gray-500 text-center font-mono">
        The Quieter You Become, The More You Are Able To Hear.
    </span>
</footer></body>
</html>
